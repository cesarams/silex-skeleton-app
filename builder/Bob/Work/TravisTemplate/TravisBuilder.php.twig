language: php

php:
- 5.5

env:
- DB=mysql

before_script:
- composer install --dev
- composer selfupdate
- pyrus install --force phpunit/DbUnit
- phpenv rehash

- mysql -e "CREATE DATABASE IF NOT EXISTS resttestdb;" -uroot;
- mysql -e "CREATE TABLE IF NOT EXISTS resttestdb.todo (id int(11) NOT NULL AUTO_INCREMENT, name varchar(255) NOT NULL, created datetime NOT NULL, PRIMARY KEY (id)) ENGINE=InnoDB DEFAULT CHARSET=utf8;" -uroot;

{% for entity in entities %}
- mysql -e "CREATE TABLE IF NOT EXISTS resttestdb.{{ entity|lower }} (id int(11) NOT NULL AUTO_INCREMENT, {% for key,value in properties %}{{ key }} varchar(255) DEFAULT NULL, {% endfor %} PRIMARY KEY (id)) ENGINE=InnoDB DEFAULT CHARSET=utf8;" -uroot;
- mysql -e "INSERT INTO resttestdb.{{ entity|lower }} VALUES(null, {% for key,value in properties %}'test_{{ key }}_{{ value }}1'{% if not loop.last %},{% endif %} {% endfor %}" -uroot;
- mysql -e "INSERT INTO resttestdb.{{ entity|lower }} VALUES(null, {% for key,value in properties %}'test_{{ key }}_{{ value }}2'{% if not loop.last %},{% endif %} {% endfor %}" -uroot;
- mysql -e "INSERT INTO resttestdb.{{ entity|lower }} VALUES(null, {% for key,value in properties %}'test_{{ key }}_{{ value }}3'{% if not loop.last %},{% endif %} {% endfor %}" -uroot;
{% endfor %}

script: phpunit -c app/